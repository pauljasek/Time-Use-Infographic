<!DOCTYPE html>
<html>
<head>
    <title>ENGR 2367H: Infographic</title>
    <style type="text/css">
        * { margin:0; padding:0; } /* to remove the top and left whitespace */

        html, body { width:100%; height:100%; color: #FFF; font-family: "Calibri";} /* just to be sure these are full screen*/

        canvas { display:block;} /* To remove the scrollbars */

        @font-face { font-family: Calibri; src: url('calibri.otf'); }
    </style>
</head>
<body style="padding: 0px; margin: 0px; overflow-y:hidden;"> <!-- background-image: url('space.png'); background-size: cover;">-->
<canvas id="main_canvas" width="1536" height="734" style="display: block; padding: 0px; margin: 0px auto;"></canvas>
<script type="text/javascript">
    window.requestAnimFrame = function(){
        return (
                window.requestAnimationFrame       ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame    ||
                window.oRequestAnimationFrame      ||
                window.msRequestAnimationFrame     ||
                function(/* function */ callback){
                    window.setTimeout(callback, 1000 / 60);
                }
        );
    }();

    /*
     * Code by Mickey Shine at http://stackoverflow.com/users/115781/mickey-shine
     */
    // --------------------------------------------------------------------------
    function touchHandler(event)
    {
        var touches = event.changedTouches,
                first = touches[0],
                type = "";
        switch(event.type)
        {
            case "touchstart": type = "mousedown"; break;
            case "touchmove":  type = "mousemove"; break;
            case "touchend":   type = "mouseup";   break;
            default:           return;
        }

        // initMouseEvent(type, canBubble, cancelable, view, clickCount,
        //                screenX, screenY, clientX, clientY, ctrlKey,
        //                altKey, shiftKey, metaKey, button, relatedTarget);

        var simulatedEvent = document.createEvent("MouseEvent");
        simulatedEvent.initMouseEvent(type, true, true, window, 1,
                first.screenX, first.screenY,
                first.clientX, first.clientY, false,
                false, false, false, 0/*left*/, null);


        first.target.dispatchEvent(simulatedEvent);
        //event.preventDefault();
    }
    document.addEventListener("touchstart", touchHandler, true);
    document.addEventListener("touchmove", touchHandler, true);
    document.addEventListener("touchend", touchHandler, true);
    document.addEventListener("touchcancel", touchHandler, true);
    // --------------------------------------------------------------------------


    var WIDTH = 1536;
    var HEIGHT = 734;

    var SETTINGS_OFFSET = 130;

    var CONTROLSUN = false;
    var SHOWSTATISTICS = false;

    var canvas = document.getElementById("main_canvas");
    document.body.style.backgroundColor = "#000";
    var ctx = canvas.getContext("2d");

    var SUN_RADIUS = 30;
    var SUN_DISTANCE = 500;
    var sunAngle = 0;
    var sunVelocity = 0;

    var unloadedElements = 0;

    var HOURS_IN_DAY = 24;

    var stats = [["Sleep", 8], ["Work", 9], ["Eat", 1], ["Leisure", 6]];
    var angles = [];
    var alphas = [];

    var baseStatistics = [
        ["time", 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
        ["Eating and Drinking", 6, 3, 3, 3, 5, 12, 32, 62, 73, 67, 53, 62, 162, 110, 61, 44, 48, 91, 155, 139, 87, 45, 21, 10],
        ["Buying Goods/Services", 2, 1, 1, 1, 1, 2, 4, 9, 21, 39, 58, 71, 79, 75, 72, 72, 68, 64, 53, 38, 27, 15, 8, 4],
        ["Other", 7, 3, 2, 2, 3, 4, 8, 15, 19, 21, 24, 25, 23, 24, 25, 27, 26, 25, 23, 24, 26, 25, 20, 11],
        ["Caring for Others", 5, 3, 3, 2, 5, 5, 17, 41, 42, 36, 35, 36, 35, 35, 41, 54, 59, 60, 55, 56, 57, 43, 20, 9],
        ["Household Activities", 7, 3, 2, 3, 8, 17, 44, 77, 104, 130, 141, 140, 131, 122, 117, 117, 131, 149, 141, 110, 76, 50, 28, 13],
        ["Leisure and Sports", 89, 45, 25, 16, 16, 27, 51, 85, 113, 150, 181, 195, 198, 231, 261, 286, 310, 323, 363, 450, 528, 526, 389, 203],
        ["Sleeping", 844, 915, 943, 951, 916, 851, 657, 425, 248, 137, 75, 49, 35, 41, 44, 42, 37, 29, 25, 30, 55, 159, 399, 676],
        ["Personal Care", 13, 7, 5, 7, 22, 40, 102, 106, 84, 63, 48, 34, 29, 23, 21, 22, 25, 29, 29, 29, 39, 51, 52, 31],
        ["Educational Activities", 3, 2, 1, 0, 1, 1, 2, 13, 33, 42, 46, 44, 38, 40, 41, 31, 23, 20, 17, 17, 17, 15, 10, 6],
        ["Organizational/Religious", 2, 1, 0, 1, 1, 3, 5, 9, 15, 27, 37, 38, 29, 19, 17, 14, 15, 17, 20, 24, 21, 13, 7, 3],
        ["Working", 22, 17, 15, 14, 22, 38, 78, 158, 248, 288, 302, 306, 241, 280, 300, 291, 258, 193, 119, 83, 67, 58, 46, 34]
    ];

    var hourStatistics = {
        "Sleeping": 8.83,
        "Personal Care": 0.81,
        "Eating and Drinking": 1.18,
        "Household Activities": 1.84,
        "Buying Goods/Services": 0.75,
        "Caring for Others": 0.70,
        "Working": 3.53,
        "Educational Activities": 0.46,
        "Organizational/Religious": 0.33,
        "Leisure and Sports": 5.21,
        "Other": 0.35
    }

    var additionalInformation = {
        "Sleeping": [
            "Americans overall are working less and sleeping",
            "more than they were a decade ago, trends that",
            "point to an aging population and fewer people",
            "in the workforce. But among those who have",
            "a job, people are working more."
        ],
        "Personal Care": [
            "This activity includes showering, going to the",
            "bathroom, oral hygiene,  etc."
        ],
        "Eating and Drinking": [
            "Americans also spend an average of 16 minutes",
            "eating and 42 minutes drinking beverages, while",
            "participating in other activities such as working,",
            "watching television, or playing sports."
        ],
        "Household Activities": [
            "These activities include doing the dishes, sweeping",
            "the floor, and general cleaning of rooms and",
            "bathrooms. However, this also includes food",
            "preparation, indoor and outdoor work, as well",
            "as caring for vehicles and pets."
        ],
        "Buying Goods/Services": [
            "In 2013, Americans surpassed $10 trillion in",
            "spending on consumer goods."
        ],
        "Caring for Others": [
            "This activity includes helping and providing for",
            "elderly family members and children as well as",
            "caring for non-family members."],
        "Working": [
            "71% of working Americans work in the private sector.",
            "These statistics factor in the travel time required",
            "for work."
        ],
        "Educational Activities": [
            "This activity includes spending time in a classroom,",
            "studying for classes, and doing outside activities",
            "such as homework."
        ],
        "Organizational/Religious": [
            "This activity entails going to the place of worship,",
            "praying, and outside service projects that are funded",
            "or for a personâ€™s specific place of worship."
        ],
        "Leisure and Sports": [
            "The most popular sports played in the United States",
            "are football, baseball, basketball, ice hockey, and",
            "soccer. This also includes activities like watching",
            "television and socialization"
        ],
        "Other": [
            "This includes email and phone communication",
            "as well as miscellaneous activities."]
    }

    var statistics = baseStatistics.slice();
    var AMOUNT = 100;

    for (var i = 1; i < baseStatistics.length; i++)
    {
        statistics[i] = statistics[i].slice();
        for (var j = 1; j < baseStatistics[i].length; j++)
        {
            statistics[i][j] = Math.round(baseStatistics[i][j] * AMOUNT / 1000);
        }
    }

    var imageDict = {
        "Sleeping": "sleeping.png",
        "Personal Care": "personalcare.png",
        "Eating and Drinking": "eating.png",
        "Working": "working.png",
        "Educational Activities": "education.png",
        "Caring for Others": "caringforothers.png",
        "Household Activities": "household.png",
        "Leisure and Sports": "leisure.png",
        "Buying Goods/Services": "shopping.png",
        "Organizational/Religious": "organization.png",
        "Other" : "other.png"
    };

    unloadedElements += statistics.length - 1;

    var area = {
        x: 0,
        y: 0,
        radius: 40,
        name: "Test",
        people: 0,
        targetPeople: 0,
        number: 0,
        angle: 0,
        textX: 0,
        textY: 0,
        hovered: false,
        maxTime: 1
    };

    var areas = [];
    var areas_length = statistics.length - 1;

    var person = {
        x: 100,
        y: 100,
        vx: 0,
        vy: 0,
        radius: 5,
        location: "Sleeping",
    };

    var slider = {
        x: 0,
        y: 0,
        width: 100,
        height: 25,
        position: .5,
        minVal: 0,
        maxVal: 1,
        precision: -1,
        hovered: false,
        hoverRange: 1.25,
        changed: false,
        waitForInput: true,
        color: "#FFF",
        displayValue: false,
        enabled: true,
        value: function()
        {
            return this.position * (this.maxVal - this.minVal) + this.minVal;
        },
        getPosition: function(val)
        {
            return (val - this.minVal)/(this.maxVal - this.minVal);
        },
        draw: function(ctx)
        {
            ctx.save();
            ctx.strokeStyle = this.color;
            ctx.globalAlpha = 0.5;
            ctx.lineWidth = 3;
            if (this.hovered)
            {
                ctx.globalAlpha = 0.95;
            }

            if (!this.enabled) {
                ctx.strokeStyle = "#999";
                ctx.globalAlpha = 0.5;
            }
            ctx.beginPath();
            ctx.moveTo(this.x, this.y + this.height/2);
            ctx.lineTo(this.x + this.width, this.y + this.height/2);
            ctx.stroke();

            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(this.x + this.position * this.width, this.y);
            ctx.lineTo(this.x + this.position * this.width, this.y + this.height);
            ctx.stroke();

            if (this.enabled) {

                if (this.displayValue) {
                    drawText(this.x + this.position * this.width, this.y + this.height + 15, this.value().toString(), "#FFF", "12pt Calibri", true);
                }
            }

            ctx.restore();
        },
        update: function(mx, my, mouseDown)
        {
            if (this.enabled) {
                this.hovered = Math.abs(this.x + this.width / 2 - mx) < this.width * this.hoverRange / 2
                        && Math.abs(this.y + this.height / 2 - my) < this.height * this.hoverRange / 2;
                if (mouseDown && this.hovered) {
                    this.position = Math.min(1, Math.max((mx - this.x) / this.width, 0));
                    if (!this.waitForInput) {
                        this.action();
                    }
                    this.changed = true;
                }
                else if (this.changed) {
                    this.action();
                    this.changed = false;
                }

                if (this.precision < 0) {
                    this.position = this.getPosition(Math.round(this.value() * Math.pow(10, this.precision)) * Math.pow(10, -this.precision));
                }
                else {
                    this.position = this.getPosition(this.value().toFixed(this.precision));
                }
            }
        },
        action: function() {}
    }

    var sliders = [];

    var amountSlider = Object.create(slider);
    amountSlider.x = 20;
    amountSlider.y = 410 + SETTINGS_OFFSET;
    amountSlider.width = 150;
    amountSlider.height = 35;
    amountSlider.minVal = 100;
    amountSlider.maxVal = 1000;
    amountSlider.precision = -1;
    amountSlider.position = amountSlider.getPosition(100);
    amountSlider.displayValue = true;
    amountSlider.waitForInput = true;
    amountSlider.action = function() {
        updateAmount(this.value());
    }
    sliders.push(amountSlider);

    var SUNSPEED = 60;

    var timeSpeedSlider = Object.create(slider);
    timeSpeedSlider.x = 20;
    timeSpeedSlider.y = 240 + SETTINGS_OFFSET;
    timeSpeedSlider.width = 150;
    timeSpeedSlider.height = 35;
    timeSpeedSlider.minVal = 0;
    timeSpeedSlider.maxVal = 120;
    timeSpeedSlider.precision = 1;
    timeSpeedSlider.position = timeSpeedSlider.getPosition(60);
    timeSpeedSlider.displayValue = false;
    timeSpeedSlider.waitForInput = false;
    timeSpeedSlider.action = function() {
        SUNSPEED = this.value();
    }
    sliders.push(timeSpeedSlider);

    var checkbox = {
        x: 0,
        y: 0,
        width: 50,
        height: 50,
        hovered: false,
        hoverRange: 1.25,
        checked: false,
        pressed: false,
        color: "#FFF",
        value: function()
        {
            return this.position * (this.maxVal - this.minVal) + this.minVal;
        },
        getPosition: function(val)
        {
            return (val - this.minVal)/(this.maxVal - this.minVal);
        },
        draw: function(ctx)
        {
            ctx.save();
            ctx.strokeStyle = this.color;
            ctx.globalAlpha = 0.5;
            ctx.lineWidth = 3;
            if (this.hovered)
            {
                ctx.globalAlpha = 0.80;
            }
            if (this.pressed)
            {
                ctx.globalAlpha = 1.0;
            }
            if (this.checked)
            {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x + 4, this.y + 4, this.width - 8, this.height - 8);
            }
            ctx.beginPath();
            ctx.rect(this.x, this.y, this.width, this.height);
            ctx.stroke();

            ctx.restore();
        },
        update: function(mx, my, mouseDown)
        {
            this.hovered = Math.abs(this.x + this.width/2 - mx) < this.width * this.hoverRange/2
                    && Math.abs(this.y + this.height/2 - my) < this.height * this.hoverRange/2;
            if (mouseDown && this.hovered)
            {
                this.pressed = true;
            }
            if (!mouseDown)
            {
                if (this.hovered && this.pressed)
                {
                    this.checked = !this.checked;
                    this.action();
                }
                this.pressed = false;
            }
        },
        action: function() {}
    }

    var checkboxes = [];

    var mouseControlCheckBox = Object.create(checkbox);
    mouseControlCheckBox.x = 150;
    mouseControlCheckBox.y = 320 + SETTINGS_OFFSET;
    mouseControlCheckBox.width = 20;
    mouseControlCheckBox.height = 20;
    mouseControlCheckBox.action = function() {
        CONTROLSUN = this.checked;
        timeSpeedSlider.enabled = !this.checked;
    };

    checkboxes.push(mouseControlCheckBox);

    var showStatisticsCheckBox = Object.create(checkbox);
    showStatisticsCheckBox.x = 150;
    showStatisticsCheckBox.y = 530 + SETTINGS_OFFSET;
    showStatisticsCheckBox.width = 20;
    showStatisticsCheckBox.height = 20;
    showStatisticsCheckBox.action = function() {
        SHOWSTATISTICS = this.checked;
    };

    checkboxes.push(showStatisticsCheckBox);

    var people = [];

    var AREARADIUS = 250;
    var TEXTRADIUS = 190;

    for (var i = 1; i < statistics.length; i++)
    {
        var newArea = Object.create(area);
        newArea.name = statistics[i][0];
        newArea.people = statistics[i][1];
        newArea.targetPeople = newArea.people;
        newArea.angle = (i-1)/areas_length * Math.PI*2 - Math.PI/2;
        if (newArea.angle < 0)
        {
            newArea.angle += Math.PI*2;
        }
        newArea.x = Math.cos(newArea.angle) * AREARADIUS + WIDTH/2;
        newArea.y = Math.sin(newArea.angle) * AREARADIUS + HEIGHT/2 + 20;
        newArea.textX = Math.cos(newArea.angle) * TEXTRADIUS + WIDTH/2;
        newArea.textY = Math.sin(newArea.angle) * TEXTRADIUS + HEIGHT/2 + 20;
        newArea.number = i - 1;

        for (var j = 1; j < statistics[i].length; j++)
        {
            if (statistics[i][j] > statistics[i][newArea.maxTime])
            {
                newArea.maxTime = j;
            }
        }

        areas.push(newArea);

        for (var j = 0; j < newArea.people; j++)
        {
            var newPerson = Object.create(person);
            newPerson.location = i - 1;
            newPerson.x = newArea.x;
            newPerson.y = newArea.y;
            newPerson.x += Math.random() * 10 - 5;
            newPerson.y += Math.random() * 10 - 5;
            people.push(newPerson);
        }
    }

    window.onload = window.onresize = function(event)
    {
        canvas.width = Math.max(document.body.clientWidth, (HEIGHT + 250) * document.body.clientHeight/HEIGHT);
        canvas.height = document.body.clientHeight;

        WIDTH = HEIGHT * canvas.width/canvas.height;

        for (var i = 0; i < areas.length; i++)
        {
            areas[i].x = Math.cos(areas[i].angle) * AREARADIUS + WIDTH/2;
            areas[i].y = Math.sin(areas[i].angle) * AREARADIUS + HEIGHT/2 + 20;
            areas[i].textX = Math.cos(areas[i].angle) * TEXTRADIUS + WIDTH/2;
            areas[i].textY = Math.sin(areas[i].angle) * TEXTRADIUS + HEIGHT/2 + 20;
        }

        ctx.scale(canvas.height/HEIGHT, canvas.height/HEIGHT);
    };

    //var colors = ["#0FF", "#009", "#F50", "#F00", "#FF0", "#FFF", "#11F", "#2C2", "#909", "#0F0", "#666"];
    var colors = [];
    for (var i = 0; i < areas_length; i++)
    {
        var hue = Math.round(i/areas_length * 360 + 30);
        if (hue < 0)
        {
            hue += 360;
        }
        colors.push("hsl(" + hue + ", 100%, 50%)");
    }

    var circleCanvases = [];
    var testPerson = Object.create(person);
    testPerson.x = testPerson.radius;
    testPerson.y = testPerson.radius;
    for (var i = 0; i < areas.length; i++)
    {
        testPerson.location = i;
        // Create a canvas element
        var newCanvas = document.createElement('canvas');
        newCanvas.width = person.radius * 2;
        newCanvas.height = person.radius * 2;

        // Get the drawing context
        var newCtx = newCanvas.getContext('2d');
        drawPerson(testPerson, newCtx);

        circleCanvases.push(newCanvas);
    }

    var time = 0;

    var sumHours = 0;
    var spacing = 0; //0.01;

    var x = 0;
    var y = 0;
    var mouseDown = false;

    canvas.addEventListener("mousemove", function (e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = canvas.width / rect.width;
        var scaleY = canvas.height / rect.height;

        x = (e.clientX - rect.left) * scaleX * HEIGHT/canvas.height;
        y = (e.clientY - rect.top) * scaleY * HEIGHT/canvas.height;
    },false);

    canvas.addEventListener("mousedown", function (e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = canvas.width / rect.width;
        var scaleY = canvas.height / rect.height;

        x = (e.clientX - rect.left) * scaleX * HEIGHT/canvas.height;
        y = (e.clientY - rect.top) * scaleY * HEIGHT/canvas.height;
        mouseDown = true;
    },false);
    canvas.addEventListener("mouseup", function (e) {
        var rect = canvas.getBoundingClientRect();
        var scaleX = canvas.width / rect.width;
        var scaleY = canvas.height / rect.height;

        x = (e.clientX - rect.left) * scaleX * HEIGHT/canvas.height;
        y = (e.clientY - rect.top) * scaleY * HEIGHT/canvas.height;
        mouseDown = false;
    },false);

    var hovering = false;
    var hoveredArea = 0;

    function checkHover()
    {
        hovering = false;
        for (var i = 0; i < areas.length; i++)
        {
            var area = areas[i];
            var squaredDistance = Math.pow(area.x - x,2) + Math.pow(area.y-y,2);
            if (squaredDistance <= Math.pow(area.radius, 2))
            {
                hovering = true;
                area.hovered = true;
                hoveredArea = i;
            }
            else
            {
                area.hovered = false;
            }
        }
    }

    for (var i = 0; i < stats.length; i++)
    {
        alphas.push(0);

        var hours = stats[i][1];

        var startAngle = sumHours/HOURS_IN_DAY * 2 * Math.PI + spacing;
        startAngle -= Math.PI/2;
        if (startAngle < 0)
        {
            startAngle += Math.PI * 2;
        }
        var endAngle = (sumHours + hours)/HOURS_IN_DAY * 2 * Math.PI - spacing;
        endAngle -= Math.PI/2;
        if (endAngle < 0)
        {
            endAngle += Math.PI * 2;
        }
        angles.push([startAngle, endAngle]);

        sumHours += hours;
    }



    for (var i = 0; i < areas_length; i++) {
        var icon = new Image();
        icon.src = imageDict[areas[i].name];

        imageDict[areas[i].name] = icon;

        icon.addEventListener("load", function (event) {
            unloadedElements -= 1;
            if (unloadedElements <= 0) {
                update();
            }
        }, false);
    }

    function updateAmount(amount)
    {
        AMOUNT = amount;

        for (var i = 1; i < baseStatistics.length; i++)
        {
            for (var j = 1; j < baseStatistics[i].length; j++)
            {
                statistics[i][j] = Math.round(baseStatistics[i][j] * AMOUNT / 1000);

            }
        }

        for (var j = 1; j < baseStatistics[0].length; j++)
        {
            var max = 1;
            var total = 0;

            for (var i = 1; i < baseStatistics.length; i++)
            {
                total += statistics[i][j];
                if (statistics[i][j] > statistics[max][j])
                {
                    max = i;
                }
            }
            statistics[max][j] += AMOUNT-total;
        }

        person.radius = Math.sqrt(1000/AMOUNT) * 2 + 1;

        var previousHour = Math.floor(time/60);
        var nextHour = Math.ceil(time/60);
        if (nextHour >= 24)
        {
            nextHour = 0;
        }
        var transition = time/60 - previousHour;

        for (var i = 0; i < areas.length; i++)
        {
            var previousHourPeople = statistics[i+1][1 + previousHour];
            var nextHourPeople = statistics[i+1][1 + nextHour];

            var targetPeople = previousHourPeople + (nextHourPeople - previousHourPeople) * transition;
            targetPeople = Math.round(targetPeople);
            areas[i].targetPeople = targetPeople;
            areas[i].people = 0;
        }

        circleCanvases = [];
        testPerson = Object.create(person);
        testPerson.x = testPerson.radius;
        testPerson.y = testPerson.radius;
        for (var i = 0; i < areas.length; i++)
        {
            testPerson.location = i;
            // Create a canvas element
            var newCanvas = document.createElement('canvas');
            newCanvas.width = person.radius * 2 + 1;
            newCanvas.height = person.radius * 2 + 1;

            // Get the drawing context
            var newCtx = newCanvas.getContext('2d');
            drawPerson(testPerson, newCtx);

            circleCanvases.push(newCanvas);
        }

        people = [];
        for (var i = 0; i < areas.length; i++)
        {
            var newArea = areas[i];
            for (var j = 0; j < newArea.targetPeople; j++) {
                var newPerson = Object.create(person);
                newPerson.location = i;
                newPerson.x = newArea.x;
                newPerson.y = newArea.y;
                newPerson.x += Math.random() * 10 - 5;
                newPerson.y += Math.random() * 10 - 5;
                newArea.people += 1;
                people.push(newPerson);
            }
        }

    }

    updateAmount(AMOUNT);


    function drawArc(a1, a2, color, border, alpha) {
        ctx.save();

        ctx.translate(WIDTH/2, HEIGHT/2 + 20);
        ctx.rotate(a1);

        ctx.fillStyle = color;
        ctx.globalAlpha = alpha;
        ctx.beginPath();

        var outer = true;

        if (!outer) {
            ctx.moveTo(0, 0);
        }
        ctx.arc(0, 0, 165, 0, a2-a1);
        if (outer) {
            ctx.arc(0, 0, 171, a2 - a1, 0, true);
        }
        else
        {
            ctx.lineTo(0, 0);
        }

        //ctx.lineTo(canvas.width / 2, HEIGHT / 2);
        ctx.fill();
        if (border) {
            ctx.strokeStyle = "rgba(255,255,255,0.2)";
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        ctx.restore();
    }

    function drawText(x, y, text, color, font, centered, stroke, strokeColor)
    {
        ctx.save();
        ctx.fillStyle = color;
        ctx.font = font;
        if (centered)
        {
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
        }
        ctx.fillText(text, x, y);
        if (stroke)
        {
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 1;
            ctx.strokeText(text, x, y);
        }
        ctx.restore();
    }

    function drawTextAtAngle(angle, radius, x, y, text, color, font, align)
    {
        ctx.save();
        ctx.fillStyle = color;
        ctx.font = font;

        ctx.textBaseline = "middle";
        ctx.textAlign = align;
        ctx.translate(x, y);
        if (angle > Math.PI/2 && angle < 3*Math.PI/2)
        {
            radius *= -1;
            angle += Math.PI;
            if (align == "right")
            {
                ctx.textAlign = "left";
            }
            if (align == "left")
            {
                ctx.textAlign = "right";
            }
        }
        ctx.rotate(angle);
        ctx.fillText(text, radius, 0);
        ctx.restore();
    }

    function drawBackground()
    {
        ctx.save();

        var alpha = (-Math.sin(sunAngle - Math.PI/6)*4 + 4)/8;

        var lgrd=ctx.createLinearGradient(0,0,0,HEIGHT);
        lgrd.addColorStop(0,"rgba(55,160,255,1)");
        lgrd.addColorStop(0.3,"rgba(50,150,240,1)");
        lgrd.addColorStop(0.6,"rgba(50,150,0,1)");
        lgrd.addColorStop(0.8,"rgba(10,0,40,1)");
        lgrd.addColorStop(1,"rgba(10,0,20,1)");

        ctx.fillStyle=lgrd;
        ctx.globalAlpha = alpha;
        ctx.fillRect(0, 0, WIDTH, HEIGHT);

        ctx.restore();

        ctx.save();

        var grd = ctx.createRadialGradient(WIDTH/2,HEIGHT/2 + 20,200,WIDTH/2,HEIGHT/2 + 20,700);
        grd.addColorStop(0, "rgba(150,150,150,1)");
        grd.addColorStop(1, "rgba(150,150,150,0)");
        ctx.fillStyle = grd;
        ctx.fillRect(0, 0, WIDTH, HEIGHT);

        lgrd=ctx.createLinearGradient(0,0,380,0);
        lgrd.addColorStop(0,"rgba(0,0,0,1)");
        lgrd.addColorStop(1,"rgba(0,0,0,0)");
        ctx.fillStyle=lgrd;
        ctx.globalAlpha = alpha;
        ctx.fillRect(0, 0, 380, HEIGHT);

        ctx.restore();
    }

    function drawSun()
    {
        var alpha = (-Math.sin(sunAngle - Math.PI/6)*4 + 4)/8;
        ctx.save();

        ctx.translate(WIDTH/2 + SUN_DISTANCE * Math.cos(sunAngle),
                HEIGHT/2 + 20 + SUN_DISTANCE * Math.sin(sunAngle));
        /*ctx.drawImage(sunImage,
                -SUN_RADIUS, -SUN_RADIUS,
                SUN_RADIUS * 2,
                SUN_RADIUS * 2);*/

        var grd = ctx.createRadialGradient(0,0,200,0,0,600);
        grd.addColorStop(0, "rgba(252,212,100,1)");
        grd.addColorStop(1, "rgba(252,212,64,0)");

        ctx.fillStyle = grd;
        ctx.globalAlpha = alpha;
        ctx.beginPath();
        //ctx.arc(0, 0, 600, 0, Math.PI*2);
        //ctx.rect(0,0,WIDTH,HEIGHT);
        ctx.fillRect(-600, -600, 1200, 1200);

        ctx.restore();
    }

    function drawMoon()
    {
        var moonAngle = sunAngle + Math.PI;
        var alpha = (Math.sin(sunAngle - Math.PI/6)*4 + 4)/8;

        ctx.save();

        ctx.translate(WIDTH/2 + SUN_DISTANCE * Math.cos(moonAngle),
                HEIGHT/2 + 20 + SUN_DISTANCE * Math.sin(moonAngle));
        /*ctx.drawImage(sunImage,
         -SUN_RADIUS, -SUN_RADIUS,
         SUN_RADIUS * 2,
         SUN_RADIUS * 2);*/

        var grd = ctx.createRadialGradient(0,0,100,0,0,300);
        grd.addColorStop(0, "rgba(255,255,255,1)");
        grd.addColorStop(1, "rgba(245,243,206,0)");

        ctx.globalAlpha = alpha;
        ctx.fillStyle = grd;
        ctx.beginPath();
        //ctx.arc(0, 0, 400, 0, Math.PI*2);
        //ctx.rect(0,0,WIDTH,HEIGHT);
        ctx.fillRect(-300, -300, 600, 600);

        ctx.restore();
    }

    function drawPerson(person, ctx)
    {
        ctx.save();

        ctx.fillStyle = colors[person.location];
        ctx.translate(person.x, person.y);
        ctx.beginPath();
        ctx.arc(0, 0, person.radius, 0, 2*Math.PI);
        ctx.fill();

        ctx.restore();
    }

    function drawPersonFast(p)
    {
        ctx.drawImage(circleCanvases[p.location], p.x-person.radius, p.y-person.radius);
    }

    function blockCircle(c1, c2)
    {
        var vx = c1.x - c2.x;
        var vy = c1.y - c2.y;

        var totalHalfWidths = c1.radius + c2.radius;

        var magnitude = Math.sqrt(vx*vx + vy*vy);

        var hit = false;

        if (magnitude < totalHalfWidths)
        {
            hit = true;

            overlap = totalHalfWidths - magnitude;

            if (magnitude != 0) {
                dx = vx / magnitude;
                dy = vy / magnitude;
            }
            else
            {
                dx = 1;
                dy = 0;
            }

            c1.x += dx * overlap;
            c1.y += dy * overlap;
        }
        else
        {
            hit = false;
        }

        return hit;
    }

    function drawArea(area)
    {
        ctx.save();

        /*ctx.translate(WIDTH/2 + Math.cos(area.angle) * 260,
                HEIGHT/2 + Math.sin(area.angle) * 260 + 20);*/

        ctx.translate(area.x,area.y);


        ctx.globalAlpha = .5;
        if (area.hovered)
        {
            ctx.globalAlpha = .9;
        }

        var percentage = (area.people) / AMOUNT;
        var roundedPercentage = Math.round(percentage * 100);

        ctx.fillStyle = "rgba(230,230,230,1)";
        ctx.beginPath();
        ctx.arc(0, 0, area.radius, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = colors[area.number];
        ctx.globalAlpha = 0.5;
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, area.radius - 3, -Math.PI/2, percentage * Math.PI * 2 - Math.PI/2);
        ctx.fill();

        if (!area.hovered) {
            ctx.globalAlpha = .7;
        }
        else
        {
            ctx.globalAlpha = .9;
        }
        if (SHOWSTATISTICS) {
            ctx.drawImage(imageDict[area.name], -19, -34, 38, 38);

            ctx.globalAlpha = 1;
            drawText(0, 15, roundedPercentage + "%", "#000", "bolder 20pt Calibri", true);///, true, "#FFF");
        }
        else
        {
            ctx.drawImage(imageDict[area.name], -27, -27, 54, 54);
        }


        ctx.restore();
    }

    function displayHoveredInfo()
    {
        ctx.save();


        ctx.translate(WIDTH/2, HEIGHT/2 + 20);

        ctx.fillStyle = "rgba(220,220,220,.8)";
        ctx.beginPath();
        ctx.arc(0, 0, 175, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();

        var timeSpent = hourStatistics[areas[hoveredArea].name];
        var hours = Math.floor(timeSpent);
        var minutes = Math.round((timeSpent-hours)*60);

        var firstLine = "We spend ";
        if (hours == 0)
        {
            firstLine = firstLine + minutes + " minutes";
        }
        else if (hours == 1)
        {
            firstLine = firstLine  + hours + " hour and " + minutes + " minutes";
        }
        else
        {
            firstLine = firstLine + hours + " hours and " + minutes + " minutes";
        }

        drawArc(-Math.PI/2, timeSpent/24 * Math.PI*2 - Math.PI/2, colors[hoveredArea], false, 0.8);

        drawText(WIDTH/2, HEIGHT/2 - 60, areas[hoveredArea].name, "#000", "bolder 18pt Calibri", true);
        drawText(WIDTH/2, HEIGHT/2 - 25, firstLine, "#000", "13pt Calibri", true);
        drawText(WIDTH/2, HEIGHT/2 - 5, "doing this activity in an average day.", "#000", "13pt Calibri", true);

        var info = additionalInformation[areas[hoveredArea].name];
        for (var i = 0; i < info.length; i++)
        {
            drawText(WIDTH/2, HEIGHT/2 + 40 + 20*i, info[i], "#111", "11pt Calibri", true);
        }
    }

    function update()
    {
        window.requestAnimFrame(update);

        checkHover();

        var angle = Math.atan2(HEIGHT/2 - y, WIDTH/2 - x);
        angle += Math.PI;
        while (angle < 0)
        {
            angle += Math.PI * 2;
        }
        while (angle > Math.PI * 2)
        {
            angle -= Math.PI * 2;
        }

        /*var selected = 0;
        for (var i = 0; i < angles.length; i++)
        {
            if (angle >= angles[i][0] && angle <= angles[i][1])
            {
                selected = i;
                break;
            }
        }*/

        if (hovering)
        {
            time = (areas[hoveredArea].maxTime - 1) * 60;
        }
        if (CONTROLSUN && !hovering) {
            sunAngle = angle;

            while (sunAngle < Math.PI / 2) {
                sunAngle += Math.PI * 2;
            }
            while (sunAngle > Math.PI * 2 + Math.PI / 2) {
                sunAngle -= Math.PI * 2;
            }

            time = (sunAngle - Math.PI / 2) * 60 * 24 / Math.PI / 2;
        }
        else {
            sunAngle = time / (60 * 24) * Math.PI * 2 + Math.PI / 2;
        }

        ctx.clearRect(0, 0, WIDTH, HEIGHT);
        drawBackground();
        drawSun();
        drawMoon();

        var previousHour = Math.floor(time/60);
        var nextHour = Math.ceil(time/60);
        if (nextHour >= 24)
        {
            nextHour = 0;
        }
        var transition = time/60 - previousHour;

        for (var i = 0; i < areas.length; i++)
        {
            var previousHourPeople = statistics[i+1][1 + previousHour];
            var nextHourPeople = statistics[i+1][1 + nextHour];

            var targetPeople = previousHourPeople + (nextHourPeople - previousHourPeople) * transition;
            targetPeople = Math.round(targetPeople);
            areas[i].targetPeople = targetPeople;
        }

        //console.log(areas[1].targetPeople, areas[1].people);

        for (var i = 0; i < people.length; i++)
        {
            if (areas[people[i].location].targetPeople < areas[people[i].location].people && Math.random() < .2)
            {
                for (var j = 0; j < areas.length; j++)
                {
                    if (areas[j].targetPeople > areas[j].people)
                    {
                        areas[people[i].location].people--;
                        people[i].location = j;
                        areas[people[i].location].people++;
                        break;
                    }
                }
            }

            //var dx = areas[people[i].location].x - people[i].x;
            //var dy = areas[people[i].location].y - people[i].y;

            //var mag = Math.sqrt(dx * dx + dy * dy) - areas[people[i].location].radius;

            //people[i].vx += dx / 100;
            //people[i].vy += dy / 100;

            people[i].vx += (areas[people[i].location].x - people[i].x)/50;
            people[i].vy += (areas[people[i].location].y - people[i].y)/50;


            people[i].vx += 1 * (Math.random() - .5);
            people[i].vy += 1 * (Math.random() - .5);

            people[i].vx *= .7;
            people[i].vy *= .7;

            people[i].x += people[i].vx;
            people[i].y += people[i].vy;

            for (var j = 0; j < people.length; j++) {
                if (j != i)
                {
                    blockCircle(people[j], people[i]);
                }
            }
            for (var j = 0; j < areas.length; j++) {
                blockCircle(people[i], areas[j]);
            }


            //drawPerson(people[i], ctx);
            drawPersonFast(people[i]);
            //people.push(people.shift());
        }

        for (var i = 0; i < areas.length; i++)
        {
            //drawText(areas[i].textX, areas[i].textY, areas[i].name, "#FFF", "16pt Verdana", true);
            //drawTextAtAngle(areas[i].angle, TEXTRADIUS, WIDTH/2, HEIGHT/2 + 20, areas[i].name, "#FFF", "12pt Arial", "left");
            drawArea(areas[i]);

        }

        if (hovering)
        {
            displayHoveredInfo();
        }


        var hour = Math.floor(time/60);
        var minute = Math.floor(time - hour*60);
        var ampmText = "AM";

        if (hour >= 12)
        {
            ampmText = "PM";
        }
        if (hour >= 13)
        {
            hour -= 12;
        }
        if (hour == 0)
        {
            hour = 12;
        }

        var hourText = hour.toString();
        if (hourText.length < 2)
        {
            hourText = "0" + hourText;
        }

        var minuteText = minute.toString();
        if (minuteText.length < 2)
        {
            minuteText = "0" + minuteText;
        }

        for (var i = 0; i < sliders.length; i++)
        {
            sliders[i].update(x, y, mouseDown);
            sliders[i].draw(ctx);
        }

        for (var i = 0; i < checkboxes.length; i++)
        {
            checkboxes[i].update(x, y, mouseDown);
            checkboxes[i].draw(ctx);
        }
        //drawText(WIDTH/2, 50, "How We Spend Our Time", "#FFF", "36pt Arial", true);
        drawText(WIDTH/2, 45, hourText + ":" + minuteText + " " + ampmText, "#FFF", "bolder 32pt Courier New", true);
        drawText(10, 45, "How We Spend Our Time", "#FFF", "bolder 24pt Calibri", false);

        drawText(10, 90, "Each colored dot represents a person", "#FFF", "14pt Calibri", false);
        drawText(10, 115, "spending time throughout the day.", "#FFF", "14pt Calibri", false);

        drawText(10, 160, "The represented population is US", "#FFF", "14pt Calibri", false);
        drawText(10, 185, "civilians over the age of 15.", "#FFF", "14pt Calibri", false);


        drawText(10, 165 + SETTINGS_OFFSET, "Settings", "#FFF", "bold 16pt Calibri", false);


        drawText(10, 195 + SETTINGS_OFFSET, "How time passes:", "#FFF", "bold 14pt Calibri", false);
        drawText(10, 235 + SETTINGS_OFFSET, "Slow", "#FFF", "14pt Calibri", false);
        drawText(150, 235 + SETTINGS_OFFSET, "Fast", "#FFF", "14pt Calibri", false);
        drawText(10, 305 + SETTINGS_OFFSET, "Control time of day with", "#FFF", "14pt Calibri", false);
        drawText(10, 335 + SETTINGS_OFFSET, "cursor position: ", "#FFF", "14pt Calibri", false);

        drawText(10, 390 + SETTINGS_OFFSET, "The amount of people:", "#FFF", "bold 14pt Calibri", false);


        drawText(10, 490 + SETTINGS_OFFSET, "Data:", "#FFF", "bold 14pt Calibri", false);

        drawText(10, 515 + SETTINGS_OFFSET, "Show quantitative activity", "#FFF", "14pt Calibri", false);
        drawText(10, 545 + SETTINGS_OFFSET, "percentages:", "#FFF", "14pt Calibri", false);


        //drawText(WIDTH/2, HEIGHT/2, hourText + ":" + minuteText + " " + ampmText, "#FFF", "32pt Courier New", true);


        if (time >= 24*60 - 1)
        {
            time = 0;
        }
        time += SUNSPEED/60;
    }



</script>
</body>
</html>